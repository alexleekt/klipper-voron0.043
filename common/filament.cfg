[gcode_macro EXTRUDE]
gcode:
    {% set MINTEMP = params.MINTEMP|default(195) %}
    {% set DISTANCE = params.DISTANCE|default(100) %}
    {% set FEEDRATE = params.FEEDRATE|default(300) %}
    SAVE_GCODE_STATE NAME=EXTRUDE_state
    {% if printer.extruder.temperature < MINTEMP and printer.extruder.target > MINTEMP|int %}
        M109 S{printer.extruder.target} ; wait for previous M104
    {% elif printer.extruder.temperature < MINTEMP %}
        M109 S{MINTEMP}               ; Wait for min E temp
    {% endif %}
    G92 E0                        ; zero the extruded length
    G0 E{DISTANCE} F{FEEDRATE}    ; extrude
    RESTORE_GCODE_STATE NAME=EXTRUDE_state

[gcode_macro FILAMENT_TO_PARK]
variable_loaded: 0
gcode:
    {% set FORCED = params.FORCED|default(0) %}
    {% if loaded or FORCED==1 %}
        EXTRUDE FEEDRATE=2100 DISTANCE=-10
        SET_GCODE_VARIABLE MACRO=FILAMENT_TO_PARK VARIABLE=loaded VALUE=0
    {% endif %}

[gcode_macro FILAMENT_TO_NOZZLE]
gcode:
    EXTRUDE FEEDRATE=300 DISTANCE=10
    SET_GCODE_VARIABLE MACRO=FILAMENT_TO_PARK VARIABLE=loaded VALUE=1

[gcode_macro MEASURE_FILAMENT]
gcode:
    {% if printer.toolhead.status == "Ready" %}
        EXTRUDE DISTANCE=100
    {% else %}
      { action_respond_info("Filament-only moves disabled while printing!") }
    {% endif %}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set DISTANCE = params.DISTANCE|default(380) %}
    {% set FEEDRATE = params.FORCED|default(1500) %}
    {% set min_extrude_temp = printer.configfile.config["extruder"]["min_extrude_temp"] %}
    {% if printer.toolhead.status == "Ready" %}
        EXTRUDE FEEDRATE={FEEDRATE|float} MINTEMP={min_extrude_temp|float} DISTANCE={DISTANCE|float}
    {% else %}
      { action_respond_info("Filament-only moves disabled while printing!") }
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set PUSH_DISTANCE = params.PUSH_DISTANCE|default(10) %}
    {% set PULL_DISTANCE = params.PULL_DISTANCE|default(-380) %}
    {% set FEEDRATE = params.FEEDRATE|default(2100) %}
    {% set min_extrude_temp = printer.configfile.config["extruder"]["min_extrude_temp"] %}
    {% if printer.toolhead.status == "Ready" %}
        EXTRUDE MINTEMP={min_extrude_temp|float} DISTANCE={1 * PUSH_DISTANCE|float}
        EXTRUDE FEEDRATE={FEEDRATE|float} MINTEMP={min_extrude_temp|float} DISTANCE={PULL_DISTANCE|float}
        M18 E
        {% else %}
      { action_respond_info("Filament-only moves disabled while printing!") }
    {% endif %}

[gcode_macro PURGE_LINE]
gcode:
    {% set X = params.X|default(40) %}
    {% set Y = params.Y|default(2.5) %}
    {% set TRAVEL = params.TRAVEL|default(40) %}
    {% set EXTRUDE = params.EXTRUDE|default(12) %}
    {% set PURGE_RATE = params.PURGE_RATE|default(500) %}
    {% set MOVE_RATE = params.MOVE_RATE|default(21000) %}
    SAVE_GCODE_STATE NAME=PURGE_state
    G0 X{X|float} Y{Y|float} F{MOVE_RATE|float}
    G1 Z0.2 F500.0
    G92 E0.0
    G1 X{X|float + TRAVEL|float} E{EXTRUDE|float} F{PURGE_RATE|float} ; intro line
    G92 E0.0
    RESTORE_GCODE_STATE NAME=PURGE_state
